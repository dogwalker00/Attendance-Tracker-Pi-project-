#!/usr/bin/env python3
import paho.mqtt.client as mqtt
import csv 
import os

thingsboard_host = 'demo.thingsboard.io'
access_token = 'Mqtv8kLjV5bbhRDUp3mv'

client = mqtt.Client()
client.username_pw_set(access_token)
client.connect(thingsboard_host, 1883, 60)

csv_file_path = 'scanned_data.csv'

# Corrected the method name and syntax
if not os.path.exists(csv_file_path):  # Changed 'exist' to 'exists' and replaced ';' with ':'
    with open(csv_file_path, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(['barcode'])  # Corrected 'writeow' to 'writerow'

def send_data(barcode):
    payload = {'barcode': barcode}
    client.publish('v1/devices/me/telemetry', str(payload))
    
    # Fixed the mode and syntax
    with open(csv_file_path, mode='a', newline='') as file:  # Added '=' in 'mode='
        writer = csv.writer(file)
        writer.writerow([barcode])  # Corrected 'writeow' to 'writerow'

# Moved the while loop outside the function
while True:
    scanned_data = input("Scan a barcode: ")
    send_data(scanned_data)

