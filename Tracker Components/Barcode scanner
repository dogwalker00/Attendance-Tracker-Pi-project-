#!/usr/bin/env python3
import paho.mqtt.client as mqtt
import csv
import os
import time
from datetime import datetime, timedelta
import json

thingsboard_host = 'demo.thingsboard.io'
access_token = 'Mqtv8kLjV5bbhRDUp3mv' 

client = mqtt.Client()
client.username_pw_set(access_token)
client.connect(thingsboard_host, 1883, 60)

# Update the CSV file path to barcode.csv
csv_file_path = 'Barcode.csv'

# Load existing data from the CSV file
def load_data():
    data = {}
    if os.path.exists(csv_file_path):
        with open(csv_file_path, mode='r', newline='') as file:
            reader = csv.reader(file)
            headers = next(reader)  # Skip header row
            for row in reader:
                name = row[0]
                barcode = row[1]
                day_data = [int(value) if value else 0 for value in row[2:]]
                data[barcode] = {'name': name, 'day_data': day_data}
    return data

# Get the next available day column
def get_next_day(data):
    for i in range(7):  # Days 1 to 7
        if all(data[barcode]['day_data'][i] == 0 for barcode in data):
            return i
    return None  # All days are filled

# Update the day data for the scanned barcode
def update_day_data(barcode, data, current_day):
    if barcode in data:
        # Update day data (increment the current day)
        if data[barcode]['day_data'][current_day] < 1:  # Increment only if it's less than 1
            data[barcode]['day_data'][current_day] += 1
            print(f"Updated {data[barcode]['name']} for Day {current_day + 1}.")
        else:
            print(f"Day {current_day + 1} for {data[barcode]['name']} is already filled.")
    else:
        print(f"Barcode {barcode} not found in the data.")

# Save updated data back to the CSV file
def save_data(data):
    with open(csv_file_path, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(['Name', 'Barcode', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'])
        for barcode, info in data.items():
            writer.writerow([info['name'], barcode] + info['day_data'])

# Publish telemetry data to ThingsBoard
def publish_telemetry(data, current_day):
    telemetry_data = {}
    for barcode, info in data.items():
        telemetry_data[info['name']] = info['day_data'][current_day]  # Send attendance for the current day

    payload = json.dumps(telemetry_data)
    client.publish('v1/devices/me/telemetry', payload)
    print("Telemetry data sent to ThingsBoard:", payload)

# Main function to run the barcode scanner
def main():
    data = load_data()
    current_day = get_next_day(data)

    if current_day is None:
        print("All days are filled. No more attendance can be recorded.")
        return

    print(f"Starting attendance collection for Day {current_day + 1}.")
    start_time = datetime.now()
    end_time = start_time + timedelta(hours=1)

    while datetime.now() < end_time:
        scanned_data = input("Scan a barcode (or type 'exit' to finish early): ")
        if scanned_data.lower() == 'exit':
            break
        update_day_data(scanned_data, data, current_day)

    save_data(data)
    publish_telemetry(data, current_day)  # Publish telemetry data
    print(f"Day {current_day + 1} attendance tracking ended.")

if __name__ == "__main__":
    main()
